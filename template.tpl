___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "AdPage Google Ads tag",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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tlMzHpunBwsWaMIZ+br0/DE69YTB8vl8tqc1y382bNWsPy/S08+/pR1l5mfjry7aLI0b7uAyIPkICJJq774qvTj/A704/wN179JeF0wYrW+cMVLDQ71sT6tXWfku/f2fH2nOX9/VO//+XLFYLO7HXMW5IEgDBATWbNy8Xb+dOV+/nTlfPbq219njjtVpJ4V0yqhB1t9437QlqtcXf6q5rxXqrfdWaPeefY3/UDN8unKDqy6sWFVdbXsCUpAvGArH/9cpwEGBgF/HDumtUcP7aeQx/TRiaB/17Zmb0Je71m4o0YfLivR+4Wq9+d4KTvYDmoCAwBVysrM0uH835Q3spt49c9WrWwf16t5RXTq1U5fctsrJzmrw56urY4qWVmhLSanWbdqqdRu3aXXRZq1cvUmRVRu1/SvOogeai4AgLWRnZ6pDu9YKBHzKzMxQVmaGKnbWfHS4rLxS0dIKywuB9MN7IEgLlZV7tXHzdtszAE/hPBAAgBECAgAwQkAAAEYICADACAEBABghIAAAIwQEAGCEgAAAjBAQAIARAgIAMEJAAABGCAgAwAgBAQAYISAAACMEBABghIAAAIwQEACAEQICADBCQAAARggIAMAIAQEAGCEgAAAjBAQAYISAAACMEBAAgBECAgAwQkAAAEYICADACAEBABghIAAAIwQEAGCEgAAAjBAQAIARAgIAMEJAAABGCAgAwAgBAQAYISAAACMEBABghIAAAIwQEACAEQICADBCQAAARggIAMAIAQEAGCEgAAAjBAQAYISAAACMEBAAgBECAgAwQkAAAEYICADACAEBABghIAAAIwQEAGCEgAAAjBAQAIARAgIAMEJAAABGCAgAwAgBAQAYISAAACMEBABghIAAAIwQEACAEQICADBCQAAARggIAMAIAQEAGCEgAAAjBAQAYISAAACMEBAAgBECAgAwQkAAAEYICADACAEBABghIAAAIwQEAGCEgAAAjBAQAIARAgIAMEJAAABGCAgAwIhfUsz2CACA+/glbbM9AgDgOtsICADAxDa/pGLbKwAArlPil7TW9goAgOsU+SUV2V4BAHCdNX5Jn9peAQBwnYhf0jLbKwAArrPML2mVpDLbSwAArlEu6XN/NFJQJWmJ7TUAANdYEo0UVO2/lMlbVqcAANzkLem/18J6xeIQAIC7LJD+G5CPJG22twUA4BLFkgql2oBEIwUxSc/bXAQAcIUXo5GCaunQy7k/a2kMAMA9Zu//DwcHZLGkL5K/BQDgEmtU0wpJBwWk9mWsAhuLAACuMKu2FZKOvCNhgaTK5O4BALhApaSZB3/hkIBEIwVbJT2VxEEAAHd4OhopKDn4C3XdE/03kvYlZw8AwAWqJE0//ItHBCQaKVgtaVYyFgEAXOHJ2jYcoq4jEEn6uaSdid0DAHCBXZJ+VtcvBOr6YmVJYVlObn6GpHGJXAUASHm/iEYK5tb1C/UdgUjSfZKOOGQBAHjGatW0oE71BiQaKaiUdFUiFgEAXOHqaKRgV32/WOdLWPtVlhSuzcnNz5V0vOOzAACp7JFopOCRhr6hoZew9rtV3DcdALwkIukHjX1TowGpfSlrkmpuYQgASG/lkiY19NLVfk05AlE0UrBC0pQ4RwEAUt/l0UhBpCnf2OB7IAerLClckZObv0fSeONZAIBUdkc0UvB4U7+5yQGRpMqSwsU5ufmdJI1q9iwAQCp7LBopuK05P9Ckl7AO8z0ddEMRAIDrzZb03eb+ULOOQCSpsqQwlpOb/zdJAyQNa+7PAwBSymxJl0UjBVXN/cFmB0Q6JCIdxctZAOBWj0m6yiQekuSL99mDofCPJP0y3scBACTVHdFIQVx/dscdEEkKhsITJf1BUisnHg8AkDDlqvmo7vPxPpAjAZGkYCgckvSspCFOPSYAwFER1Zwk2KTzPBpj8imsOtUOOk5Sg9dOAQBY8YikkU7FQ3LwCORgwVB4nKQnVPNJLQCAPaslTY1GCt5w+oGNPoXVmNqr+M6UtFfSCZIyE/E8AIB67ZR0j6RLo5GCVYl4goQcgRwsGAr3kPRjSWElKFgAgAOqJBVIuicaKdiQyCdKeED2C4bCA1RzafjJkrKT9bwA4BGVkv4oaUY0UpCUu8kmLSD7BUPhXNUcjVwpqX+ynx8A0swXkmZJKohGCkqS+cRJD8h+wVDYJ+kUSReq5n4jnWxtAQCX2SLpOdWcOrE4GimI2RhhLSAHq43JCElnSzpV0omSWlsdBQCpo0zSEklvSXpF0ke2onGwlAjI4YKhcEDSINVcrHGIpL6S+kjqLKm9pA5K0e0AYCAmaVvtP8WS1koqUs3txJdJWmV6vapE+n8xXmaFbhql1gAAAABJRU5ErkJggg\u003d\u003d"
  },
  "description": "Boost your Google Ads conversions by up to 25% with AdPage\u0027s serverside tag, offering direct import capabilities to the Google Ads API for more accurate tracking.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "conversionActionId",
    "displayName": "Conversion Action Id",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "conversionValue",
    "displayName": "Value",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "currencyCode",
    "displayName": "Currency",
    "simpleValueType": true,
    "help": "For example: EUR, USD, GBP"
  },
  {
    "type": "TEXT",
    "name": "transaction_id",
    "displayName": "Transaction_id",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "authentication",
    "displayName": "Authentication Credentials",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "taggingApiKey",
        "displayName": "Tagging API key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "attributionGroup",
    "displayName": "Conversion Identifiers",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "conversionDateTime",
        "displayName": "conversionDateTime",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "gbraid",
        "displayName": "gbraid",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "wbraid",
        "displayName": "wbraid",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "gclid",
        "displayName": "gclid",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "logData",
    "checkboxText": "enable Log",
    "simpleValueType": true
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "userData",
    "displayName": "User Data",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Property Name",
        "name": "name",
        "type": "SELECT",
        "selectItems": [
          {
            "value": "hashedEmail",
            "displayValue": "Email"
          },
          {
            "value": "hashedPhoneNumber",
            "displayValue": "Phone"
          },
          {
            "value": "thirdPartyUserId",
            "displayValue": "Third Party User ID"
          },
          {
            "value": "addressInfo",
            "displayValue": "Address Info"
          }
        ]
      },
      {
        "defaultValue": "",
        "displayName": "Property Value",
        "name": "value",
        "type": "TEXT"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const JSON = require("JSON");
const makeString = require("makeString");
const makeNumber = require("makeNumber");
const makeInteger = require("makeInteger");
const logToConsole = require("logToConsole");
const sendHttpRequest = require("sendHttpRequest");
const getAllEventData = require("getAllEventData");
const getType = require("getType");
const sha256Sync = require("sha256Sync");
const getTimestampMillis = require("getTimestampMillis");
const Object = require("Object");
const Math = require("Math");
const postBody = getData();
sendConversionRequest();

function sendConversionRequest() {
  const postUrl =
    "https://api.tryforwarder.com/api/google-ads-proxy/upload-click-conversions?taggingApiKey=" +
    data.taggingApiKey;

  logToConsole("sendConversionRequest");

  if (data.logData) {
    logToConsole(
      JSON.stringify({
        Name: "GAdsOfflineConversion",
        Type: "Request",
        EventName: makeString(data.conversionActionId),
        RequestMethod: "POST",
        RequestUrl: postUrl,
        RequestBody: postBody,
      })
    );
  }

  sendHttpRequest(
    postUrl,
    (statusCode, headers, body) => {
      if (data.logData) {
        logToConsole(
          JSON.stringify({
            Name: "GAdsOfflineConversion",
            Type: "Response",
            EventName: makeString(data.conversionActionId),
            ResponseStatusCode: statusCode,
            ResponseHeaders: headers,
            ResponseBody: body,
          })
        );
      }

      if (statusCode >= 200 && statusCode < 400) {
        data.gtmOnSuccess();
      } else {
        data.gtmOnFailure();
      }
    },
    { method: "POST", headers: { 'Content-Type': 'application/json' } },
    JSON.stringify(postBody)
  );
}

function getData() {
  const eventData = getAllEventData();
  let mappedData = {
    conversionAction:
      "customers/[CUSTOMER_ID]/conversionActions/" + data.conversionActionId,
  };

  mappedData = addConversionAttribution(eventData, mappedData);
  mappedData = addPurchaseData(eventData, mappedData);
  mappedData = addUserIdentifiers(eventData, mappedData);

  return {
    conversions: [mappedData],
    partialFailure: true,
    validateOnly: false,
    debugEnabled: data.logData || false,
  };
}

function addConversionAttribution(eventData, mappedData) {
  const braid = data.gbraid || eventData.gbraid;
  const wbraid = data.wbraid || eventData.wbraid;
  const gclid = data.gclid || eventData.gclid;
  if (gclid) {
    mappedData.gclid = gclid;
  } else if (braid) {
    mappedData.braid = braid;
  } else if (wbraid) {
    mappedData.wbraid = wbraid;
  }

  if (eventData.marketing_data) {
    if (eventData.marketing_data.gclid) {
      mappedData.gclid = eventData.marketing_data.gclid;
    } else if (eventData.marketing_data.gbraid) {
      mappedData.braid = eventData.marketing_data.gbraid;
    } else if (eventData.marketing_data.wbraid) {
      mappedData.wbraid = eventData.marketing_data.wbraid;
    }
  }

  if (data.conversionDateTime) {
    let processed_at = data.conversionDateTime;
    if (processed_at.indexOf("T") != -1) {
      processed_at = processed_at.replace("T", " ");
    }
    if (processed_at.indexOf(".") != -1) {
      processed_at = processed_at.split(".")[0] + "+00:00";
    }
    mappedData.conversionDateTime = processed_at;
    logToConsole("data.conversionDateTime");
  } else if (eventData.processed_at) {
    logToConsole("eventData.processed_at");
    logToConsole(eventData.processed_at);
    let processed_at = eventData.processed_at;
    if (processed_at.indexOf("T") != -1) {
      processed_at = processed_at.replace("T", " ");
    }
    if (processed_at.indexOf(".") != -1) {
      processed_at = processed_at.split(".")[0] + "+00:00";
    }
    mappedData.conversionDateTime = processed_at;
  } else {
    mappedData.conversionDateTime = convertTimestampToISO(getTimestampMillis());
    logToConsole("getTimestampMillis");
  }

  return mappedData;
}

function addPurchaseData(eventData, mappedData) {
  let currencyFromItems = "";
  let valueFromItems = 0;
  let items = data.items;

  if (!items && eventData.line_items && eventData.line_items[0]) {
    items = [];
    currencyFromItems = eventData.line_items[0].currency;

    eventData.line_items.forEach((d, i) => {
      let item = {};

      if (d.sku) item.product_id = makeString(d.sku);
      else if (d.product_id) item.productId = makeString(d.product_id);
      else if (d.id) item.productId = makeString(d.id);

      if (d.item_quantity) item.quantity = makeInteger(d.item_quantity);
      else if (d.quantity) item.quantity = makeInteger(d.quantity);

      if (d.item_price) {
        item.unitPrice = makeNumber(d.item_price);
        valueFromItems += item.quantity
          ? item.quantity * item.unitPrice
          : item.unitPrice;
      } else if (d.price) {
        item.unitPrice = makeNumber(d.price);
        valueFromItems += item.quantity
          ? item.quantity * item.unitPrice
          : item.unitPrice;
      }

      items[i] = item;
    });
  }

  if (items) {
    mappedData.cartData = {};

    if (items) mappedData.cartData.items = items;
  }

  if (data.orderId) mappedData.orderId = makeString(data.orderId);
  else if (eventData.order_number)
    mappedData.orderId = makeString(eventData.order_number);
  else if (eventData.orderId)
    mappedData.orderId = makeString(eventData.orderId);
  else if (eventData.order_id)
    mappedData.orderId = makeString(eventData.order_id);
  else if (eventData.transaction_id)
    mappedData.orderId = makeString(eventData.transaction_id);

  if (data.conversionValue)
    mappedData.conversionValue = makeNumber(data.conversionValue);
  else if (eventData.total_price)
    mappedData.conversionValue = makeNumber(eventData.total_price);
  else if (eventData.value)
    mappedData.conversionValue = makeNumber(eventData.value);
  else if (eventData.conversionValue)
    mappedData.conversionValue = makeNumber(eventData.conversionValue);
  else if (eventData["x-ga-mp1-ev"])
    mappedData.conversionValue = makeNumber(eventData["x-ga-mp1-ev"]);
  else if (eventData["x-ga-mp1-tr"])
    mappedData.conversionValue = makeNumber(eventData["x-ga-mp1-tr"]);
  else if (valueFromItems)
    mappedData.conversionValue = makeNumber(valueFromItems);
  else mappedData.conversionValue = 1;

  if (data.currencyCode) mappedData.currencyCode = data.currencyCode;
  else if (eventData.currency) mappedData.currencyCode = eventData.currency;
  else if (eventData.currencyCode)
    mappedData.currencyCode = eventData.currencyCode;
  else if (currencyFromItems) mappedData.currencyCode = currencyFromItems;
  else mappedData.currencyCode = "USD";

  return mappedData;
}

function addUserIdentifiers(eventData, mappedData) {
  let hashedEmail;
  let hashedPhoneNumber;
  let userIdentifiersMapped = [];
  let userEventData = {};
  let usedIdentifiers = [];

  if (getType(eventData.user_data) === "object") {
    userEventData =
      eventData.user_data || eventData.user_properties || eventData.user;
  }

  if (data.userData) {
    let userIdentifiers = [];

    data.userData.forEach((d) => {
      let identifier = {};

      identifier[d.name] = hashData(d.name, d.value);
      identifier.userIdentifierSource = d.userIdentifierSource;

      userIdentifiers.push(identifier);
      usedIdentifiers.push(d.name);
    });

    userIdentifiersMapped = userIdentifiers;
  }

  if (eventData.hashedEmail) hashedEmail = eventData.hashedEmail;
  else if (eventData.email) hashedEmail = eventData.email;
  else if (eventData.email_address) hashedEmail = eventData.email_address;
  else if (userEventData.email) hashedEmail = userEventData.email;
  else if (userEventData.email_address)
    hashedEmail = userEventData.email_address;

  if (usedIdentifiers.indexOf("hashedEmail") === -1 && hashedEmail) {
    userIdentifiersMapped.push({
      hashedEmail: hashData("hashedEmail", hashedEmail),
      userIdentifierSource: "UNSPECIFIED",
    });
  }

  if (eventData.phone) {
    hashedPhoneNumber = eventData.phone;
  } else if (eventData.customer) {
    if (eventData.customer.phone) {
      hashedPhoneNumber = eventData.customer.phone;
    }
  } else if (eventData.phone_number) {
    hashedPhoneNumber = eventData.phone_number;
  } else if (userEventData.phone) {
    hashedPhoneNumber = userEventData.phone;
  } else if (userEventData.phone_number) {
    hashedPhoneNumber = userEventData.phone_number;
  }

  if (
    usedIdentifiers.indexOf("hashedPhoneNumber") === -1 &&
    hashedPhoneNumber
  ) {
    userIdentifiersMapped.push({
      hashedPhoneNumber: hashData("hashedPhoneNumber", hashedPhoneNumber),
      userIdentifierSource: "UNSPECIFIED",
    });
  }

  if (userIdentifiersMapped) {
    mappedData.userIdentifiers = userIdentifiersMapped;
  }

  return mappedData;
}

function hashData(key, value) {
  if (!value) {
    return value;
  }

  const type = getType(value);

  if (type === "undefined" || value === "undefined") {
    return undefined;
  }

  if (type === "array") {
    return value.map((val) => {
      return hashData(key, val);
    });
  }

  if (type === "object") {
    return Object.keys(value).reduce((acc, val) => {
      acc[val] = hashData(key, value[val]);
      return acc;
    }, {});
  }

  if (isHashed(value)) {
    return value;
  }

  value = makeString(value).trim().toLowerCase();

  if (key === "hashedPhoneNumber") {
    value = value
      .split(" ")
      .join("")
      .split("-")
      .join("")
      .split("(")
      .join("")
      .split(")")
      .join("");
  } else if (key === "hashedEmail") {
    let valueParts = value.split("@");

    if (valueParts[1] === "gmail.com" || valueParts[1] === "googlemail.com") {
      value = valueParts[0].split(".").join("") + "@" + valueParts[1];
    } else {
      value = valueParts.join("@");
    }
  }

  return sha256Sync(value, { outputEncoding: "hex" });
}
function isHashed(value) {
  if (!value) {
    return false;
  }

  return makeString(value).match("^[A-Fa-f0-9]{64}$") !== null;
}
function convertTimestampToISO(timestamp) {
  const secToMs = function (s) {
    return s * 1000;
  };
  const minToMs = function (m) {
    return m * secToMs(60);
  };
  const hoursToMs = function (h) {
    return h * minToMs(60);
  };
  const daysToMs = function (d) {
    return d * hoursToMs(24);
  };
  const format = function (value) {
    return value >= 10 ? value.toString() : "0" + value;
  };
  const fourYearsInMs = daysToMs(365 * 4 + 1);
  let year = 1970 + Math.floor(timestamp / fourYearsInMs) * 4;
  timestamp = timestamp % fourYearsInMs;

  while (true) {
    let isLeapYear = !(year % 4);
    let nextTimestamp = timestamp - daysToMs(isLeapYear ? 366 : 365);
    if (nextTimestamp < 0) {
      break;
    }
    timestamp = nextTimestamp;
    year = year + 1;
  }

  const daysByMonth =
    year % 4 === 0
      ? [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]
      : [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

  let month = 0;
  for (let i = 0; i < daysByMonth.length; i++) {
    let msInThisMonth = daysToMs(daysByMonth[i]);
    if (timestamp > msInThisMonth) {
      timestamp = timestamp - msInThisMonth;
    } else {
      month = i + 1;
      break;
    }
  }
  let date = Math.ceil(timestamp / daysToMs(1));
  timestamp = timestamp - daysToMs(date - 1);
  let hours = Math.floor(timestamp / hoursToMs(1));
  timestamp = timestamp - hoursToMs(hours);
  let minutes = Math.floor(timestamp / minToMs(1));
  timestamp = timestamp - minToMs(minutes);
  let sec = Math.floor(timestamp / secToMs(1));

  return (
    year +
    "-" +
    format(month) +
    "-" +
    format(date) +
    " " +
    format(hours) +
    ":" +
    format(minutes) +
    ":" +
    format(sec) +
    "+00:00"
  );
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.tryforwarder.com/"
              },
              {
                "type": 1,
                "string": "https://api.trytagging.com/"
              }
            ]
          }
        },
        {
          "key": "allowGoogleDomains",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 09.01.2024, 12:24:48


